---
const title = "Mortgage Calculator (with Agent & Escrow)";
const description =
  "Calculate monthly mortgage payments, total interest, and a detailed breakdown. Includes optional agent commission, escrow items (property tax, insurance, HOA), PMI estimate, tables, and an FAQ.";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{title}</title>
    <meta name="description" content={description} />

    <style>
      :root{
        --bg:#f5f7fb;
        --card:#ffffff;
        --text:#0f172a;
        --muted:#64748b;
        --line:#e5e7eb;
        --primary:#2563eb;
        --primary-2:#1e40af;
        --soft:#eef2ff;
        --soft-2:#dbeafe;
        --shadow:0 10px 26px rgba(15,23,42,.10);
        --radius:14px;
        --radius-sm:12px;
        --ok:#16a34a;
        --wait:#f59e0b;
        --bad:#ef4444;
      }

      *{ box-sizing:border-box; }
      body{
        margin:0;
        font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
        background:var(--bg);
        color:var(--text);
      }
      .wrap{ max-width:1100px; margin:22px auto; padding:0 16px 32px; }
      .page-title{
        display:flex; align-items:center; gap:10px;
        font-size:20px; font-weight:900;
        margin:6px 0 10px; color:#111827;
      }
      .page-title .icon{
        width:32px;height:32px;border-radius:10px;
        background:linear-gradient(135deg,var(--primary),#60a5fa);
        box-shadow:0 10px 18px rgba(37,99,235,.25);
        display:flex;align-items:center;justify-content:center;
        color:#fff;font-weight:950;
      }
      .subtitle{ margin:0 0 14px; color:var(--muted); font-size:14px; }

      .card{
        background:var(--card);
        border:1px solid var(--line);
        border-radius:var(--radius);
        box-shadow:var(--shadow);
        overflow:hidden;
      }
      .tabs{
        display:flex; gap:0; border-bottom:1px solid var(--line);
        background:#fff; padding:10px 10px 0; overflow-x:auto;
      }
      .tab{
        appearance:none;
        border:1px solid var(--line);
        border-bottom:none;
        background:#f8fafc;
        color:#334155;
        padding:10px 14px;
        border-top-left-radius:12px;
        border-top-right-radius:12px;
        font-weight:900;
        cursor:pointer;
        white-space:nowrap;
        margin-right:8px;
      }
      .tab[aria-selected="true"]{
        background:#fff;
        color:var(--primary-2);
        box-shadow:0 -1px 0 #fff inset;
      }

      .panel{ padding:16px; }
      [data-panel]{ display:none; }
      [data-panel].active{ display:block; }

      .grid{
        display:grid;
        grid-template-columns:1fr;
        gap:14px;
      }
      @media (min-width: 980px){
        .grid{ grid-template-columns:1.2fr .8fr; align-items:start; }
      }

      .box{
        border:1px solid var(--line);
        border-radius:var(--radius-sm);
        background:#fff;
        padding:14px;
      }
      .box-title{
        display:flex; align-items:flex-end; justify-content:space-between;
        gap:10px; margin-bottom:10px;
      }
      .box-title h2{ margin:0; font-size:14px; font-weight:950; color:#111827; }
      .hint{ font-size:12px; color:var(--muted); }

      .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; }
      .field{
        display:flex; flex-direction:column; gap:6px;
        min-width:210px; flex:1 1 210px;
      }
      .field label{ font-size:12px; font-weight:950; color:#111827; }
      .inline{ display:flex; gap:10px; align-items:center; }
      .input{
        border:1px solid var(--line);
        border-radius:12px;
        padding:10px 12px;
        font-size:14px;
        outline:none;
        width:100%;
        background:#fff;
      }
      .input:focus{ border-color:#93c5fd; box-shadow:0 0 0 3px rgba(147,197,253,.35); }
      .mini-sm{ width:140px; flex:0 0 140px; }

      .btn{
        border:1px solid var(--line);
        background:#fff;
        padding:10px 14px;
        border-radius:12px;
        cursor:pointer;
        font-weight:900;
      }
      .btn:hover{ border-color:#cbd5e1; background:#f8fafc; }
      .btn.primary{ border-color:#93c5fd; background:var(--soft); color:#0b3b76; }

      .note{
        margin-top:10px;
        padding:10px 12px;
        border:1px solid var(--line);
        border-radius:12px;
        background:#fbfdff;
        color:#0f172a;
        font-size:13px;
      }
      .note.warn{ border-color:#fde68a; background:#fffbeb; }
      .note.bad{ border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.06); color:#7f1d1d; }

      .big{
        border-radius:var(--radius-sm);
        border:1px solid #c7d2fe;
        background:linear-gradient(180deg,#eef2ff,#ffffff);
        padding:14px;
        position:sticky;
        top:14px;
      }
      .big-head{
        display:flex; align-items:center; justify-content:space-between;
        gap:10px; margin-bottom:10px;
      }
      .status{
        font-size:12px; font-weight:950;
        padding:6px 10px;
        border-radius:999px;
        border:1px solid var(--line);
        background:#fff;
        color:#0f172a;
      }
      .status.ok{ border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.08); color:#14532d; }
      .status.wait{ border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); color:#7c2d12; }

      .big-title{ margin:0; font-size:14px; font-weight:950; color:#111827; }
      .big-sub{ margin:0 0 12px; color:var(--muted); font-size:12px; }

      .kv{
        border:1px solid var(--line);
        border-radius:14px;
        background:#fff;
        padding:12px;
      }
      .kv + .kv{ margin-top:10px; }

      .kv-k{
        font-size:12px; color:var(--muted);
        font-weight:950;
        display:flex; align-items:center; justify-content:space-between;
        gap:10px;
      }
      .badge{
        display:inline-flex; align-items:center;
        padding:5px 8px;
        border-radius:999px;
        border:1px solid var(--line);
        background:#fff;
        font-size:12px;
        font-weight:950;
        color:#0f172a;
        white-space:nowrap;
      }
      .kv-v{
        margin-top:6px;
        font-size:34px;
        font-weight:980;
        letter-spacing:-0.02em;
        color:#0f172a;
        line-height:1.05;
      }
      .kv-u{ margin-top:6px; font-size:12px; color:var(--muted); }

      .divider{ height:1px; background:var(--line); margin:14px 0; }

      .table{
        width:100%;
        border-collapse:collapse;
        margin-top:10px;
        font-size:14px;
      }
      .table th, .table td{
        border:1px solid var(--line);
        padding:10px;
        text-align:left;
        vertical-align:top;
      }
      .table th{ background:#f8fafc; font-weight:950; }

      .foot{ margin-top:16px; display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
      a{ color:var(--primary-2); text-decoration:none; }
      a:hover{ text-decoration:underline; }

      .recent{
        margin-top:10px;
        font-size:13px;
        color:var(--muted);
        max-height:140px;
        overflow:auto;
        padding-right:6px;
      }
      .recent div{ margin:6px 0; }

      .split-2{
        display:grid;
        grid-template-columns:1fr;
        gap:14px;
      }
      @media (min-width: 920px){
        .split-2{ grid-template-columns:1fr 1fr; }
      }
    </style>
  </head>

  <body>
    <main class="wrap">
      <div class="page-title">
        <div class="icon">üè†</div>
        <div>Mortgage Calculator</div>
      </div>
      <p class="subtitle">
        Estimate monthly mortgage payments (P&amp;I), plus escrow items (property tax, insurance, HOA), optional PMI,
        and optional deal-cost estimates (closing costs + agent commission).
      </p>

      <section class="card" aria-label="mortgage-calculator">
        <div class="tabs" role="tablist" aria-label="Sections">
          <button class="tab" role="tab" aria-selected="true" data-tab="calc">Calculator</button>
          <button class="tab" role="tab" aria-selected="false" data-tab="breakdown">Breakdown</button>
          <button class="tab" role="tab" aria-selected="false" data-tab="tables">Tables</button>
          <button class="tab" role="tab" aria-selected="false" data-tab="faq">FAQ</button>
        </div>

        <div class="panel">
          <!-- Calculator -->
          <div data-panel="calc" class="active">
            <div class="grid">
              <!-- Inputs -->
              <div>
                <div class="box">
                  <div class="box-title">
                    <h2>1) Loan inputs</h2>
                    <div class="hint">Updates as you type</div>
                  </div>

                  <div class="row">
                    <div class="field">
                      <label for="homePrice">Home price</label>
                      <input id="homePrice" class="input" type="number" step="any" inputmode="decimal" placeholder="e.g. 800000" />
                    </div>

                    <div class="field">
                      <label for="downType">Down payment</label>
                      <div class="inline">
                        <input id="downValue" class="input" type="number" step="any" inputmode="decimal" placeholder="e.g. 20" />
                        <select id="downType" class="input mini-sm" aria-label="down payment type">
                          <option value="percent" selected>%</option>
                          <option value="amount">$</option>
                        </select>
                      </div>
                    </div>

                    <div class="field">
                      <label for="rate">Interest rate (APR)</label>
                      <div class="inline">
                        <input id="rate" class="input" type="number" step="any" inputmode="decimal" placeholder="e.g. 6.5" />
                        <span class="badge">%</span>
                      </div>
                    </div>

                    <div class="field">
                      <label for="termYears">Term</label>
                      <div class="inline">
                        <input id="termYears" class="input" type="number" step="1" inputmode="numeric" placeholder="e.g. 30" />
                        <span class="badge">years</span>
                      </div>
                    </div>

                    <div class="field">
                      <label for="loanType">Loan type</label>
                      <select id="loanType" class="input">
                        <option value="fixed" selected>Fixed (amortized)</option>
                        <option value="interestOnly">Interest-only (estimate)</option>
                      </select>
                    </div>

                    <button type="button" id="clearBtn" class="btn">Clear</button>
                  </div>

                  <div class="note warn">
                    Tip: Fill <strong>price + down + APR + term</strong> to get the monthly principal &amp; interest (P&amp;I).
                  </div>
                </div>

                <div class="box" style="margin-top:14px;">
                  <div class="box-title">
                    <h2>2) Escrow items (monthly)</h2>
                    <div class="hint">Taxes, insurance, HOA, etc.</div>
                  </div>

                  <div class="row">
                    <div class="field">
                      <label for="propTaxYear">Property tax (annual)</label>
                      <input id="propTaxYear" class="input" type="number" step="any" inputmode="decimal" placeholder="e.g. 12000" />
                    </div>

                    <div class="field">
                      <label for="insYear">Home insurance (annual)</label>
                      <input id="insYear" class="input" type="number" step="any" inputmode="decimal" placeholder="e.g. 1800" />
                    </div>

                    <div class="field">
                      <label for="hoaMonth">HOA (monthly)</label>
                      <input id="hoaMonth" class="input" type="number" step="any" inputmode="decimal" placeholder="e.g. 300" />
                    </div>

                    <div class="field">
                      <label for="otherEscrowMonth">Other escrow (monthly)</label>
                      <input id="otherEscrowMonth" class="input" type="number" step="any" inputmode="decimal" placeholder="e.g. 50" />
                    </div>
                  </div>

                  <div class="note">
                    Escrow per month = (annual tax / 12) + (annual insurance / 12) + HOA + other.
                  </div>
                </div>

                <div class="box" style="margin-top:14px;">
                  <div class="box-title">
                    <h2>3) Agent commission + closing costs</h2>
                    <div class="hint">Helps estimate deal cash needs</div>
                  </div>

                  <div class="row">
                    <div class="field">
                      <label for="agentPct">Total agent commission</label>
                      <div class="inline">
                        <input id="agentPct" class="input" type="number" step="any" inputmode="decimal" placeholder="e.g. 5" />
                        <span class="badge">%</span>
                      </div>
                    </div>

                    <div class="field">
                      <label for="agentWhoPays">Who pays commission?</label>
                      <select id="agentWhoPays" class="input">
                        <option value="seller" selected>Seller (typical)</option>
                        <option value="buyer">Buyer</option>
                        <option value="split">Split 50/50</option>
                      </select>
                    </div>

                    <div class="field">
                      <label for="closingPct">Closing costs (% of price)</label>
                      <div class="inline">
                        <input id="closingPct" class="input" type="number" step="any" inputmode="decimal" placeholder="e.g. 2" />
                        <span class="badge">%</span>
                      </div>
                    </div>

                    <div class="field">
                      <label for="closingFlat">Closing costs (flat $)</label>
                      <input id="closingFlat" class="input" type="number" step="any" inputmode="decimal" placeholder="e.g. 8000" />
                    </div>
                  </div>

                  <div class="note warn">
                    Commission is usually paid by the seller, but you can model other scenarios here. Closing costs can be
                    entered as a percent and/or a flat amount (they add together).
                  </div>
                </div>

                <div class="box" style="margin-top:14px;">
                  <div class="box-title">
                    <h2>4) Optional: PMI (monthly)</h2>
                    <div class="hint">Common if down payment &lt; 20%</div>
                  </div>

                  <div class="row">
                    <div class="field">
                      <label for="pmiPctYear">PMI rate (annual % of loan)</label>
                      <div class="inline">
                        <input id="pmiPctYear" class="input" type="number" step="any" inputmode="decimal" placeholder="e.g. 0.6" />
                        <span class="badge">%</span>
                      </div>
                    </div>

                    <div class="field">
                      <label for="pmiEnabled">PMI toggle</label>
                      <select id="pmiEnabled" class="input">
                        <option value="auto" selected>Auto (if down &lt; 20%)</option>
                        <option value="on">Always on</option>
                        <option value="off">Off</option>
                      </select>
                    </div>
                  </div>

                  <div class="note">
                    PMI estimate: PMI(month) ‚âà loan √ó (PMI annual rate / 100) √∑ 12
                  </div>
                </div>
              </div>

              <!-- Big Result -->
              <aside class="big" aria-live="polite">
                <div class="big-head">
                  <div>
                    <p class="big-title">Monthly payment</p>
                    <p class="big-sub" id="summaryLine">Enter values to see results.</p>
                  </div>
                  <span id="statusPill" class="status wait">Waiting</span>
                </div>

                <div class="kv">
                  <div class="kv-k">
                    <span>Total monthly</span>
                    <span class="badge">PITI+</span>
                  </div>
                  <div class="kv-v" id="outTotal">‚Äî</div>
                  <div class="kv-u">P&amp;I + escrow + PMI (if any)</div>
                </div>

                <div class="kv">
                  <div class="kv-k"><span>Principal &amp; Interest (P&amp;I)</span><span class="badge">/mo</span></div>
                  <div class="kv-v" id="outPI">‚Äî</div>
                  <div class="kv-u" id="outLoan">Loan: ‚Äî</div>
                </div>

                <div class="kv">
                  <div class="kv-k"><span>Escrow (tax/ins/HOA)</span><span class="badge">/mo</span></div>
                  <div class="kv-v" id="outEscrow">‚Äî</div>
                  <div class="kv-u" id="outEscrowSmall">‚Äî</div>
                </div>

                <div class="kv">
                  <div class="kv-k"><span>PMI</span><span class="badge">/mo</span></div>
                  <div class="kv-v" id="outPMI">‚Äî</div>
                  <div class="kv-u" id="outPMISmall">‚Äî</div>
                </div>

                <div class="divider"></div>

                <div class="kv">
                  <div class="kv-k"><span>Cash needed (estimate)</span><span class="badge">at closing</span></div>
                  <div class="kv-v" id="outCash">‚Äî</div>
                  <div class="kv-u" id="outCashSmall">Down + buyer closing + buyer commission (if any)</div>
                </div>

                <div class="divider"></div>

                <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                  <div class="hint" style="font-weight:900; color:#111827;">Recent</div>
                  <button type="button" id="copyBtn" class="btn">Copy</button>
                </div>
                <div class="recent" id="recentList">No calculations yet.</div>

                <div class="note bad" id="warnBox" style="display:none; margin-top:12px;"></div>
              </aside>
            </div>
          </div>

          <!-- Breakdown -->
          <div data-panel="breakdown">
            <div class="split-2">
              <div class="box">
                <div class="box-title">
                  <h2>Payment breakdown</h2>
                  <div class="hint">PITI(+)</div>
                </div>

                <table class="table" aria-label="payment breakdown">
                  <thead>
                    <tr><th>Item</th><th>Monthly</th><th>Notes</th></tr>
                  </thead>
                  <tbody>
                    <tr><td>Principal &amp; Interest</td><td id="bPI">‚Äî</td><td>Fixed-rate amortized estimate</td></tr>
                    <tr><td>Property tax</td><td id="bTax">‚Äî</td><td>Annual / 12</td></tr>
                    <tr><td>Insurance</td><td id="bIns">‚Äî</td><td>Annual / 12</td></tr>
                    <tr><td>HOA</td><td id="bHOA">‚Äî</td><td>Monthly HOA</td></tr>
                    <tr><td>Other escrow</td><td id="bOther">‚Äî</td><td>Any other monthly items</td></tr>
                    <tr><td>PMI</td><td id="bPMI">‚Äî</td><td>Estimate (often if down &lt; 20%)</td></tr>
                    <tr><th>Total</th><th id="bTotal">‚Äî</th><th>Total monthly</th></tr>
                  </tbody>
                </table>

                <div class="note warn">
                  Escrow is often collected monthly and paid by your loan servicer when bills are due.
                </div>
              </div>

              <div class="box">
                <div class="box-title">
                  <h2>Deal cost estimate</h2>
                  <div class="hint">Not part of monthly payment</div>
                </div>

                <table class="table" aria-label="deal costs">
                  <thead>
                    <tr><th>Item</th><th>Amount</th><th>Who pays</th></tr>
                  </thead>
                  <tbody>
                    <tr><td>Down payment</td><td id="dDown">‚Äî</td><td>Buyer</td></tr>
                    <tr><td>Buyer closing costs</td><td id="dBuyerClose">‚Äî</td><td>Buyer</td></tr>
                    <tr><td>Agent commission (total)</td><td id="dAgentTotal">‚Äî</td><td id="dAgentWho">‚Äî</td></tr>
                    <tr><td>Buyer-paid commission</td><td id="dBuyerAgent">‚Äî</td><td>Buyer</td></tr>
                    <tr><th>Estimated cash needed</th><th id="dCash">‚Äî</th><th>Buyer</th></tr>
                  </tbody>
                </table>

                <div class="note">
                  Typically, the buyer does not pay the listing/buyer-agent commission directly; this is optional modeling.
                </div>
              </div>
            </div>

            <div class="box" style="margin-top:14px;">
              <div class="box-title">
                <h2>Lifetime totals (rough)</h2>
                <div class="hint">Based on current inputs</div>
              </div>

              <table class="table" aria-label="lifetime totals">
                <thead>
                  <tr><th>Metric</th><th>Value</th><th>Notes</th></tr>
                </thead>
                <tbody>
                  <tr><td>Total paid (P&amp;I only)</td><td id="tPaidPI">‚Äî</td><td>Monthly P&amp;I √ó number of payments</td></tr>
                  <tr><td>Total interest (estimate)</td><td id="tInterest">‚Äî</td><td>Total P&amp;I ‚àí principal</td></tr>
                  <tr><td>Total escrow (estimate)</td><td id="tEscrow">‚Äî</td><td>Monthly escrow √ó term (real life varies)</td></tr>
                  <tr><td>Total PMI (estimate)</td><td id="tPMI">‚Äî</td><td>Simple estimate (PMI often ends earlier)</td></tr>
                </tbody>
              </table>

              <div class="note warn">
                This tool does not model extra payments, rate changes, refi, tax/insurance increases, or PMI cancellation timing.
                Use it for fast comparisons.
              </div>
            </div>
          </div>

          <!-- Tables -->
          <div data-panel="tables">
            <div class="box">
              <div class="box-title">
                <h2>Quick reference tables</h2>
                <div class="hint">Build intuition</div>
              </div>

              <table class="table" aria-label="rate effect table">
                <thead>
                  <tr><th>Loan</th><th>Rate</th><th>Term</th><th>P&amp;I (approx)</th></tr>
                </thead>
                <tbody>
                  <tr><td>$400,000</td><td>6%</td><td>30y</td><td>~$2,398/mo</td></tr>
                  <tr><td>$400,000</td><td>7%</td><td>30y</td><td>~$2,661/mo</td></tr>
                  <tr><td>$600,000</td><td>6.5%</td><td>30y</td><td>~$3,792/mo</td></tr>
                  <tr><td>$600,000</td><td>6.5%</td><td>15y</td><td>~$5,226/mo</td></tr>
                </tbody>
              </table>

              <div class="note warn">
                These are rough values. Your actual total payment depends on taxes, insurance, HOA, PMI, and fees.
              </div>
            </div>
          </div>

          <!-- FAQ -->
          <div data-panel="faq">
            <div class="box">
              <div class="box-title">
                <h2>FAQ</h2>
                <div class="hint">Short answers</div>
              </div>

              <p><strong>What is escrow?</strong> Many lenders collect taxes/insurance/HOA monthly and pay the bills when due.</p>
              <p><strong>Why is my ‚Äútotal monthly‚Äù bigger than P&amp;I?</strong> Because it includes escrow items and optional PMI.</p>
              <p><strong>Do buyers pay agent commission?</strong> Often the seller pays, but deal structures vary‚Äîthis tool lets you model scenarios.</p>
              <p><strong>Is PMI accurate?</strong> It‚Äôs a simple estimate. Real PMI depends on credit, loan type, and usually cancels when LTV improves.</p>
            </div>
          </div>

          <div class="foot">
            <a href="/">‚Üê Back to Home</a>
            <span class="subtitle" style="margin:0;">SEO-safe, no framework</span>
          </div>
        </div>
      </section>
    </main>

    <script>
      // -----------------------
      // Tabs (robust)
      // -----------------------
      const tabs = Array.from(document.querySelectorAll(".tab"));
      const panels = Array.from(document.querySelectorAll("[data-panel]"));
      function setTab(name){
        tabs.forEach(t => t.setAttribute("aria-selected", t.dataset.tab === name ? "true" : "false"));
        panels.forEach(p => p.classList.toggle("active", p.dataset.panel === name));
      }
      tabs.forEach(t => {
        t.type = "button";
        t.addEventListener("click", (e) => { e.preventDefault(); setTab(t.dataset.tab); });
      });
      const initialTab =
        tabs.find(t => t.getAttribute("aria-selected") === "true")?.dataset.tab
        || tabs[0]?.dataset.tab
        || "calc";
      setTab(initialTab);

      // -----------------------
      // Helpers
      // -----------------------
      const $ = (id) => document.getElementById(id);
      const fmt = new Intl.NumberFormat("en-US", { style:"currency", currency:"USD", maximumFractionDigits:0 });
      const fmt2 = new Intl.NumberFormat("en-US", { style:"currency", currency:"USD", maximumFractionDigits:2 });

      function num(v){
        const x = parseFloat(v);
        return Number.isFinite(x) ? x : NaN;
      }
      function clampNonNeg(x){ return Number.isFinite(x) ? Math.max(0, x) : NaN; }

      function monthlyPI_fixed(loan, annualRatePct, years){
        if (!Number.isFinite(loan) || !Number.isFinite(annualRatePct) || !Number.isFinite(years)) return NaN;
        if (loan <= 0 || years <= 0) return NaN;
        const n = Math.round(years * 12);
        const r = (annualRatePct / 100) / 12;
        if (r === 0) return loan / n;
        const pow = Math.pow(1 + r, n);
        return loan * (r * pow) / (pow - 1);
      }

      function monthlyPI_interestOnly(loan, annualRatePct){
        if (!Number.isFinite(loan) || !Number.isFinite(annualRatePct)) return NaN;
        if (loan <= 0) return NaN;
        const r = (annualRatePct / 100) / 12;
        return loan * r;
      }

      function percentToAmount(price, pct){ return price * (pct / 100); }

      // -----------------------
      // DOM refs
      // -----------------------
      const homePrice = $("homePrice");
      const downValue = $("downValue");
      const downType  = $("downType");
      const rate      = $("rate");
      const termYears = $("termYears");
      const loanType  = $("loanType");
      const clearBtn  = $("clearBtn");

      // escrow
      const propTaxYear = $("propTaxYear");
      const insYear     = $("insYear");
      const hoaMonth    = $("hoaMonth");
      const otherEscrowMonth = $("otherEscrowMonth");

      // agent + closing
      const agentPct = $("agentPct");
      const agentWhoPays = $("agentWhoPays");
      const closingPct = $("closingPct");
      const closingFlat = $("closingFlat");

      // pmi
      const pmiPctYear = $("pmiPctYear");
      const pmiEnabled = $("pmiEnabled");

      // outputs (big)
      const statusPill = $("statusPill");
      const summaryLine = $("summaryLine");
      const outTotal = $("outTotal");
      const outPI = $("outPI");
      const outEscrow = $("outEscrow");
      const outPMI = $("outPMI");
      const outCash = $("outCash");
      const outLoan = $("outLoan");
      const outEscrowSmall = $("outEscrowSmall");
      const outPMISmall = $("outPMISmall");
      const outCashSmall = $("outCashSmall");
      const warnBox = $("warnBox");

      // breakdown tables
      const bPI = $("bPI"), bTax = $("bTax"), bIns = $("bIns"), bHOA = $("bHOA"), bOther = $("bOther"), bPMI = $("bPMI"), bTotal = $("bTotal");
      const dDown = $("dDown"), dBuyerClose = $("dBuyerClose"), dAgentTotal = $("dAgentTotal"), dAgentWho = $("dAgentWho"), dBuyerAgent = $("dBuyerAgent"), dCash = $("dCash");
      const tPaidPI = $("tPaidPI"), tInterest = $("tInterest"), tEscrow = $("tEscrow"), tPMI = $("tPMI");

      // recent
      const recentList = $("recentList");
      const copyBtn = $("copyBtn");
      const recent = [];

      function setStatus(ok, text){
        statusPill.classList.toggle("ok", ok);
        statusPill.classList.toggle("wait", !ok);
        statusPill.textContent = text;
      }

      function pushRecent(text){
        if (!text) return;
        recent.unshift(text);
        if (recent.length > 10) recent.pop();
        renderRecent();
      }

      function renderRecent(){
        if (recent.length === 0){
          recentList.textContent = "No calculations yet.";
          return;
        }
        recentList.innerHTML = recent.map(s => `<div>‚Ä¢ ${s}</div>`).join("");
      }

      function compute(){
        warnBox.style.display = "none";
        warnBox.textContent = "";

        const price = clampNonNeg(num(homePrice.value));
        const dpRaw = clampNonNeg(num(downValue.value));
        const apr = num(rate.value);
        const yrs = num(termYears.value);

        if (!Number.isFinite(price) || price <= 0 || !Number.isFinite(dpRaw) || !Number.isFinite(apr) || !Number.isFinite(yrs)){
          setStatus(false, "Waiting");
          summaryLine.textContent = "Enter home price, down payment, APR, and term.";
          outTotal.textContent = "‚Äî";
          outPI.textContent = "‚Äî";
          outEscrow.textContent = "‚Äî";
          outPMI.textContent = "‚Äî";
          outCash.textContent = "‚Äî";
          outLoan.textContent = "Loan: ‚Äî";
          outEscrowSmall.textContent = "‚Äî";
          outPMISmall.textContent = "‚Äî";
          outCashSmall.textContent = "Down + buyer closing + buyer commission (if any)";
          [bPI,bTax,bIns,bHOA,bOther,bPMI,bTotal,dDown,dBuyerClose,dAgentTotal,dAgentWho,dBuyerAgent,dCash,tPaidPI,tInterest,tEscrow,tPMI].forEach(el => el.textContent = "‚Äî");
          return;
        }

        // down payment
        let downAmt = 0;
        if (downType.value === "percent"){
          downAmt = percentToAmount(price, dpRaw);
        } else {
          downAmt = dpRaw;
        }
        downAmt = Math.min(downAmt, price);

        const loan = price - downAmt;

        // monthly P&I
        let monthlyPI = NaN;
        if (loanType.value === "interestOnly"){
          monthlyPI = monthlyPI_interestOnly(loan, apr);
        } else {
          monthlyPI = monthlyPI_fixed(loan, apr, yrs);
        }

        // escrow monthly
        const taxM = (clampNonNeg(num(propTaxYear.value)) || 0) / 12;
        const insM = (clampNonNeg(num(insYear.value)) || 0) / 12;
        const hoaM = clampNonNeg(num(hoaMonth.value)) || 0;
        const othM = clampNonNeg(num(otherEscrowMonth.value)) || 0;
        const escrowM = taxM + insM + hoaM + othM;

        // PMI monthly
        const pmiRate = clampNonNeg(num(pmiPctYear.value));
        const dpPct = (downAmt / price) * 100;

        let pmiOn = false;
        if (pmiEnabled.value === "on") pmiOn = true;
        else if (pmiEnabled.value === "off") pmiOn = false;
        else pmiOn = dpPct < 20;

        const pmiM = (pmiOn && Number.isFinite(pmiRate) && pmiRate > 0)
          ? (loan * (pmiRate / 100) / 12)
          : 0;

        const totalMonthly = monthlyPI + escrowM + pmiM;

        // closing costs
        const closePct = clampNonNeg(num(closingPct.value)) || 0;
        const closeFlat = clampNonNeg(num(closingFlat.value)) || 0;
        const buyerClosing = (price * (closePct/100)) + closeFlat;

        // agent commission
        const agentP = clampNonNeg(num(agentPct.value)) || 0;
        const agentTotal = price * (agentP/100);
        let buyerAgent = 0;
        let whoText = "Seller (typical)";
        if (agentWhoPays.value === "buyer"){
          buyerAgent = agentTotal;
          whoText = "Buyer";
        } else if (agentWhoPays.value === "split"){
          buyerAgent = agentTotal * 0.5;
          whoText = "Split";
        }

        // cash needed (estimate)
        const cashNeeded = downAmt + buyerClosing + buyerAgent;

        // lifetime totals
        const n = Math.round(yrs * 12);
        const totalPaidPI = monthlyPI * n;
        const totalInterest = (loanType.value === "interestOnly")
          ? (monthlyPI * n)
          : (totalPaidPI - loan);

        const totalEscrow = escrowM * n;
        const totalPMI = pmiM * n;

        // status + warnings
        if (!Number.isFinite(monthlyPI) || monthlyPI <= 0){
          setStatus(false, "Invalid");
          summaryLine.textContent = "Inputs lead to invalid payment (check rate/term).";
          outTotal.textContent = "‚Äî";
          outPI.textContent = "‚Äî";
          outLoan.textContent = `Loan: ${fmt.format(loan)}`;
          return;
        }

        setStatus(true, "Ready");
        summaryLine.textContent =
          `Price ${fmt.format(price)} ¬∑ Down ${fmt.format(downAmt)} (${Math.round(dpPct*100)/100}%) ¬∑ Loan ${fmt.format(loan)}`;

        outTotal.textContent = fmt2.format(totalMonthly);
        outPI.textContent = fmt2.format(monthlyPI);
        outEscrow.textContent = fmt2.format(escrowM);
        outPMI.textContent = pmiM > 0 ? fmt2.format(pmiM) : "$0";
        outLoan.textContent = `Loan: ${fmt.format(loan)} ¬∑ ${loanType.value === "interestOnly" ? "Interest-only estimate" : "Fixed amortized"}`;

        outEscrowSmall.textContent = `Tax ${fmt2.format(taxM)} + Ins ${fmt2.format(insM)} + HOA ${fmt2.format(hoaM)} + Other ${fmt2.format(othM)}`;
        outPMISmall.textContent = pmiOn ? `PMI rate ${pmiRate || 0}%/yr (estimate)` : `PMI off (or down ‚â• 20%)`;

        outCash.textContent = fmt.format(cashNeeded);
        outCashSmall.textContent = `Down ${fmt.format(downAmt)} + Buyer closing ${fmt.format(buyerClosing)} + Buyer commission ${fmt.format(buyerAgent)}`;

        // breakdown table
        bPI.textContent = fmt2.format(monthlyPI);
        bTax.textContent = fmt2.format(taxM);
        bIns.textContent = fmt2.format(insM);
        bHOA.textContent = fmt2.format(hoaM);
        bOther.textContent = fmt2.format(othM);
        bPMI.textContent = pmiM > 0 ? fmt2.format(pmiM) : "$0";
        bTotal.textContent = fmt2.format(totalMonthly);

        dDown.textContent = fmt.format(downAmt);
        dBuyerClose.textContent = fmt.format(buyerClosing);
        dAgentTotal.textContent = fmt.format(agentTotal);
        dAgentWho.textContent = whoText;
        dBuyerAgent.textContent = fmt.format(buyerAgent);
        dCash.textContent = fmt.format(cashNeeded);

        tPaidPI.textContent = fmt.format(totalPaidPI);
        tInterest.textContent = Number.isFinite(totalInterest) ? fmt.format(totalInterest) : "‚Äî";
        tEscrow.textContent = fmt.format(totalEscrow);
        tPMI.textContent = fmt.format(totalPMI);

        // warning logic
        const warnings = [];
        if (dpPct < 10) warnings.push("Down payment < 10%: financing may be harder and PMI may be higher.");
        if (apr >= 9) warnings.push("APR seems high. Double-check the interest rate.");
        if (escrowM > monthlyPI) warnings.push("Escrow is larger than P&I. Make sure property tax/HOA inputs are correct.");
        if (loanType.value === "interestOnly") warnings.push("Interest-only shown is an estimate; real loans may have balloon/reset terms.");
        if (warnings.length){
          warnBox.style.display = "block";
          warnBox.textContent = warnings.join(" ");
        }

        // recent line
        const rec = `${fmt.format(price)} ¬∑ Down ${Math.round(dpPct*100)/100}% ¬∑ APR ${apr}% ¬∑ ${yrs}y ‚Üí ${fmt2.format(totalMonthly)}/mo`;
        pushRecent(rec);
      }

      function bindAll(){
        const inputs = [
          homePrice, downValue, downType, rate, termYears, loanType,
          propTaxYear, insYear, hoaMonth, otherEscrowMonth,
          agentPct, agentWhoPays, closingPct, closingFlat,
          pmiPctYear, pmiEnabled
        ];
        inputs.forEach(el => {
          el.addEventListener("input", compute);
          el.addEventListener("change", compute);
        });

        $("clearBtn").addEventListener("click", () => {
          homePrice.value = "";
          downValue.value = "";
          downType.value = "percent";
          rate.value = "";
          termYears.value = "30";
          loanType.value = "fixed";

          propTaxYear.value = "";
          insYear.value = "";
          hoaMonth.value = "";
          otherEscrowMonth.value = "";

          agentPct.value = "";
          agentWhoPays.value = "seller";
          closingPct.value = "";
          closingFlat.value = "";

          pmiPctYear.value = "";
          pmiEnabled.value = "auto";

          recent.length = 0;
          renderRecent();
          compute();
        });

        $("copyBtn").addEventListener("click", async () => {
          const text = recent.length ? recent[0] : "";
          if (!text) return;
          try{
            await navigator.clipboard.writeText(text);
            copyBtn.textContent = "Copied";
            setTimeout(() => (copyBtn.textContent = "Copy"), 900);
          }catch(e){
            copyBtn.textContent = "Copy failed";
            setTimeout(() => (copyBtn.textContent = "Copy"), 900);
          }
        });
      }

      bindAll();

      // sensible defaults
      termYears.value = termYears.value || "30";
      renderRecent();
      compute();
    </script>
  </body>
</html>
